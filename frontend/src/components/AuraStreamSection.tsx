import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import gameConfig from '../config/gameConfig.json';
import KaelIntroModal from './KaelIntroModal';
import MilestoneCelebration from './MilestoneCelebration';
import AvatarEvolutionAnimation from './AvatarEvolutionAnimation';
import kaelDialogue from '../content/kaelDialogue.json';
import './AuraStreamSection.css';

interface StravaConnectionStatus {
  connected: boolean;
  athleteInfo?: {
    id: number;
    firstname: string;
    lastname: string;
    profile: string;
    city: string;
    country: string;
    sex: string;
  };
  lastSync?: Date;
}

const AuraStreamSection: React.FC = () => {
  const { userData, currentUser } = useAuth();
  const [stravaStatus, setStravaStatus] = useState<StravaConnectionStatus>({ connected: false });
  const [syncing, setSyncing] = useState(false);
  const [syncMessage, setSyncMessage] = useState<string | null>(null);
  
  // Kael UI state
  const [showKaelIntro, setShowKaelIntro] = useState(false);
  const [showMilestoneCelebration, setShowMilestoneCelebration] = useState(false);
  const [milestoneData, setMilestoneData] = useState<{tier: number, stamina: number} | null>(null);
  const [showEvolutionAnimation, setShowEvolutionAnimation] = useState(false);
  const [evolutionData, setEvolutionData] = useState<{fromTier: number, toTier: number} | null>(null);

  const staminaPoints = userData?.stamina_points || 0;
  const avatarTier = userData?.avatar_tier || 0;
  const currentTierData = gameConfig.AVATAR_TIERS[avatarTier.toString() as keyof typeof gameConfig.AVATAR_TIERS];
  const nextTier = avatarTier + 1;
  const nextTierData = gameConfig.AVATAR_TIERS[nextTier.toString() as keyof typeof gameConfig.AVATAR_TIERS];
  const nextThreshold = gameConfig.AVATAR_EVOLUTION_THRESHOLDS[`TIER_${nextTier}` as keyof typeof gameConfig.AVATAR_EVOLUTION_THRESHOLDS];

  useEffect(() => {
    if (userData) {
      const previousStatus = stravaStatus.connected;
      setStravaStatus({
        connected: userData.strava_connected || false,
        athleteInfo: userData.strava_athlete_info,
        lastSync: userData.last_activity_sync?.toDate()
      });

      // Show Kael intro modal if user hasn't connected Strava yet
      if (!userData.strava_connected && !localStorage.getItem('kael_intro_dismissed')) {
        setShowKaelIntro(true);
      }

      // Show connection success message from Kael
      if (!previousStatus && userData.strava_connected) {
        setSyncMessage(`‚öîÔ∏è ${kaelDialogue.connectionSuccess.message}`);
        localStorage.setItem('kael_intro_dismissed', 'true');
      }
    }
  }, [userData]);

  // Monitor for avatar tier changes to trigger celebrations
  useEffect(() => {
    const previousTier = localStorage.getItem('previous_avatar_tier');
    const currentTier = avatarTier;

    if (previousTier && parseInt(previousTier) < currentTier) {
      // Trigger evolution animation first
      setEvolutionData({
        fromTier: parseInt(previousTier),
        toTier: currentTier
      });
      setShowEvolutionAnimation(true);

      // Then show milestone celebration after animation
      setTimeout(() => {
        setMilestoneData({
          tier: currentTier,
          stamina: staminaPoints
        });
        setShowMilestoneCelebration(true);
      }, 6000); // Wait for evolution animation to complete
    }

    // Store current tier for next comparison
    localStorage.setItem('previous_avatar_tier', currentTier.toString());
  }, [avatarTier, staminaPoints]);

  const handleConnectStrava = async () => {
    try {
      if (!currentUser) return;
      
      const idToken = await currentUser.getIdToken();
      
      // Use production API URL during development since rewrites only work in production
      const apiUrl = process.env.NODE_ENV === 'development' 
        ? 'https://goreal-native.web.app/api/getStravaAuthUrl'
        : '/api/getStravaAuthUrl';
        
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${idToken}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        window.location.href = data.authUrl;
      } else {
        throw new Error('Failed to get Strava auth URL');
      }
    } catch (error) {
      console.error('Error connecting to Strava:', error);
      setSyncMessage('‚ùå L·ªói k·∫øt n·ªëi Strava. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  const handleDisconnectStrava = async () => {
    if (!window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ng·∫Øt k·∫øt n·ªëi v·ªõi Strava?')) {
      return;
    }

    try {
      if (!currentUser) return;
      
      const idToken = await currentUser.getIdToken();
      
      // Use production API URL during development
      const apiUrl = process.env.NODE_ENV === 'development' 
        ? 'https://goreal-native.web.app/api/disconnectStrava'
        : '/api/disconnectStrava';
        
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${idToken}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        setStravaStatus({ connected: false });
        setSyncMessage('‚úÖ ƒê√£ ng·∫Øt k·∫øt n·ªëi Strava th√†nh c√¥ng');
      } else {
        throw new Error('Failed to disconnect Strava');
      }
    } catch (error) {
      console.error('Error disconnecting Strava:', error);
      setSyncMessage('‚ùå L·ªói ng·∫Øt k·∫øt n·ªëi Strava. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  const handleSyncActivities = async () => {
    if (syncing) return;

    setSyncing(true);
    setSyncMessage(null);

    try {
      if (!currentUser) return;
      
      const idToken = await currentUser.getIdToken();
      
      // Use production API URL during development
      const apiUrl = process.env.NODE_ENV === 'development' 
        ? 'https://goreal-native.web.app/api/syncStravaActivities'
        : '/api/syncStravaActivities';
        
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${idToken}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (response.ok && data.success) {
        setSyncMessage(
          `‚úÖ ƒê√£ ƒë·ªìng b·ªô ${data.activities_processed} ho·∫°t ƒë·ªông! ` +
          `+${data.stamina_gained} Stamina` +
          (data.tier_upgraded ? ` üéâ ThƒÉng c·∫•p l√™n ${nextTierData?.name}!` : '')
        );
        
        // Refresh user data
        window.location.reload();
      } else {
        throw new Error(data.message || 'Sync failed');
      }
    } catch (error) {
      console.error('Error syncing activities:', error);
      setSyncMessage(`‚ùå L·ªói ƒë·ªìng b·ªô: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setSyncing(false);
    }
  };

  const calculateProgress = () => {
    if (!nextThreshold) return 100; // Max tier reached
    
    const currentThreshold = gameConfig.AVATAR_EVOLUTION_THRESHOLDS[`TIER_${avatarTier}` as keyof typeof gameConfig.AVATAR_EVOLUTION_THRESHOLDS];
    const progress = ((staminaPoints - currentThreshold) / (nextThreshold - currentThreshold)) * 100;
    return Math.min(Math.max(progress, 0), 100);
  };

  return (
    <div className="aura-stream-section">
      <div className="section-header">
        <h2 className="aura-stream-title">
          <span className="stream-icon">‚ö°</span>
          D√≤ng Ch·∫£y AURA
        </h2>
        <p className="section-description">
          K·∫øt n·ªëi Strava ƒë·ªÉ chuy·ªÉn h√≥a ho·∫°t ƒë·ªông th·ªÉ thao th√†nh s·ª©c m·∫°nh AURA
        </p>
      </div>

      {/* Strava Connection Status */}
      <div className="strava-connection">
        <div className="connection-header">
          <div className="strava-logo">
            <span>üèÉ‚Äç‚ôÇÔ∏è</span>
          </div>
          <div className="connection-info">
            <h3>K·∫øt n·ªëi Strava</h3>
            {stravaStatus.connected ? (
              <div className="connected-status">
                <span className="status-indicator connected"></span>
                <span className="status-text">ƒê√£ k·∫øt n·ªëi</span>
                {stravaStatus.athleteInfo && (
                  <span className="athlete-name">{stravaStatus.athleteInfo.firstname} {stravaStatus.athleteInfo.lastname}</span>
                )}
              </div>
            ) : (
              <div className="disconnected-status">
                <span className="status-indicator disconnected"></span>
                <span className="status-text">Ch∆∞a k·∫øt n·ªëi</span>
              </div>
            )}
          </div>
        </div>

        <div className="connection-actions">
          {stravaStatus.connected ? (
            <div className="connected-actions">
              <button 
                className="sync-button primary" 
                onClick={handleSyncActivities}
                disabled={syncing}
              >
                {syncing ? (
                  <>
                    <span className="spinner"></span>
                    ƒêang ƒë·ªìng b·ªô...
                  </>
                ) : (
                  <>
                    <span className="sync-icon">üîÑ</span>
                    ƒê·ªìng B·ªô Ho·∫°t ƒê·ªông
                  </>
                )}
              </button>
              <button 
                className="disconnect-button secondary" 
                onClick={handleDisconnectStrava}
              >
                Ng·∫Øt K·∫øt N·ªëi
              </button>
            </div>
          ) : (
            <button 
              className="connect-button primary" 
              onClick={handleConnectStrava}
            >
              <span className="connect-icon">üîó</span>
              K·∫øt N·ªëi Strava
            </button>
          )}
        </div>

        {stravaStatus.lastSync && (
          <div className="last-sync-info">
            <span className="sync-label">ƒê·ªìng b·ªô l·∫ßn cu·ªëi:</span>
            <span className="sync-time">
              {stravaStatus.lastSync.toLocaleString('vi-VN')}
            </span>
          </div>
        )}
      </div>

      {/* Stamina & Avatar Status */}
      <div className="stamina-section">
        <div className="stats-grid">
          <div className="stat-card stamina">
            <div className="stat-icon">üí™</div>
            <div className="stat-info">
              <h4>Stamina Points</h4>
              <div className="stat-value">{staminaPoints.toLocaleString()}</div>
            </div>
          </div>
          
          <div className="stat-card avatar">
            <div className="stat-icon">üé≠</div>
            <div className="stat-info">
              <h4>Avatar Tier</h4>
              <div className="stat-value">{currentTierData?.name || 'Ng∆∞·ªùi M·ªõi'}</div>
              <div className="tier-level">C·∫•p {avatarTier}</div>
            </div>
          </div>
        </div>

        {/* Progress to Next Tier */}
        {nextTierData && (
          <div className="tier-progress">
            <div className="progress-header">
              <h4>Ti·∫øn Tr√¨nh ThƒÉng C·∫•p</h4>
              <span className="next-tier">{nextTierData.name}</span>
            </div>
            
            <div className="progress-bar">
              <div 
                className="progress-fill" 
                style={{ width: `${calculateProgress()}%` }}
              ></div>
            </div>
            
            <div className="progress-info">
              <span className="current-progress">
                {staminaPoints} / {nextThreshold} Stamina
              </span>
              <span className="remaining">
                C√≤n {nextThreshold - staminaPoints} ƒë·ªÉ thƒÉng c·∫•p
              </span>
            </div>
          </div>
        )}

        {avatarTier === 10 && (
          <div className="max-tier-achieved">
            <div className="achievement-icon">üëë</div>
            <h4>ƒê√£ ƒê·∫°t C·∫•p ƒê·ªô T·ªëi Cao!</h4>
            <p>B·∫°n ƒë√£ tr·ªü th√†nh V√¥ C·ª±c - ƒë·ªânh cao c·ªßa s·ª©c m·∫°nh!</p>
          </div>
        )}
      </div>

      {/* Activity History Preview */}
      {stravaStatus.connected && (
        <div className="activity-preview">
          <h4>Ho·∫°t ƒê·ªông G·∫ßn ƒê√¢y</h4>
          <div className="activity-summary">
            <div className="summary-item">
              <span className="activity-icon">üèÉ‚Äç‚ôÇÔ∏è</span>
              <span className="activity-stat">
                {userData?.total_distance_run?.toFixed(1) || '0'} km ch·∫°y
              </span>
            </div>
            <div className="summary-item">
              <span className="activity-icon">üèä‚Äç‚ôÇÔ∏è</span>
              <span className="activity-stat">
                {userData?.total_distance_swim?.toFixed(1) || '0'} km b∆°i
              </span>
            </div>
            <div className="summary-item">
              <span className="activity-icon">üö¥‚Äç‚ôÇÔ∏è</span>
              <span className="activity-stat">
                {userData?.total_distance_cycle?.toFixed(1) || '0'} km ƒë·∫°p xe
              </span>
            </div>
          </div>
        </div>
      )}

      {/* Sync Message */}
      {syncMessage && (
        <div className={`sync-message ${syncMessage.startsWith('‚úÖ') ? 'success' : 'error'}`}>
          {syncMessage}
        </div>
      )}

      {/* Stamina Rates Info */}
      <div className="stamina-rates">
        <h4>T·ª∑ L·ªá Stamina</h4>
        <div className="rates-grid">
          <div className="rate-item">
            <span className="rate-icon">üèÉ‚Äç‚ôÇÔ∏è</span>
            <span className="rate-text">Ch·∫°y: 1 ƒëi·ªÉm/km</span>
          </div>
          <div className="rate-item">
            <span className="rate-icon">üèä‚Äç‚ôÇÔ∏è</span>
            <span className="rate-text">B∆°i: 50 ƒëi·ªÉm/km</span>
          </div>
          <div className="rate-item">
            <span className="rate-icon">üö¥‚Äç‚ôÇÔ∏è</span>
            <span className="rate-text">ƒê·∫°p xe: 0.3 ƒëi·ªÉm/km</span>
          </div>
          <div className="rate-item">
            <span className="rate-icon">üö∂‚Äç‚ôÇÔ∏è</span>
            <span className="rate-text">ƒêi b·ªô: 0.5 ƒëi·ªÉm/km</span>
          </div>
        </div>
      </div>

      {/* Kael Interactive Components */}
      <KaelIntroModal
        isVisible={showKaelIntro}
        onClose={() => {
          setShowKaelIntro(false);
          localStorage.setItem('kael_intro_dismissed', 'true');
        }}
        onConnectStrava={handleConnectStrava}
      />

      <MilestoneCelebration
        isVisible={showMilestoneCelebration}
        tier={milestoneData?.tier || 0}
        staminaPoints={milestoneData?.stamina || 0}
        onClose={() => setShowMilestoneCelebration(false)}
      />

      <AvatarEvolutionAnimation
        isActive={showEvolutionAnimation}
        fromTier={evolutionData?.fromTier || 0}
        toTier={evolutionData?.toTier || 0}
        onAnimationComplete={() => setShowEvolutionAnimation(false)}
      />
    </div>
  );
};

export default AuraStreamSection;